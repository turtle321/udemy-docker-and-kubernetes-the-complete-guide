# NOTE: this file is indeed supposed to be in the root dir in order for Github to recognize it.

language: generic # In case of error: rakefile not found
sudo: required
services:
  - docker
env:
  global:
    # The SHA is used in `deploy.sh`.
    - SHA=$(git rev-parse HEAD)
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1

before_install:
  - cd ./section14-15-16-17/complex # Change dir because that is where the src is. Usually you don't need this.

  # Install Google Cloud SDK, kubectl and authorize it.
  - curl https://sdk.cloud.google.com | bash > /dev/null;
  - source $HOME/google-cloud-sdk/path.bash.inc
  - gcloud components update kubectl
  # Authorization. `service-account.json` is generated by my Google Cloud,
  # then encrypted using Travis CI CLI, then uploaded to my Travis CI.
  # Setup the encryption key used to encrypt `service-account.json`
  ###- openssl......
  ###- gcloud auth activate-service-account --key-file service-account.json
  # Google Cloud project configs.
  ###- gcloud config set project ....
  ###- gcloud config set compute/zone ....
  ###- gcloud container clusters get credentials ....
  # Login in Docker CLI.
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # Build container.
  - docker build -t nimiq/react-test -f ./client/Dockerfile.dev ./client

script:
  # - docker run nimiq/react-test npm test -- --coverage
  - docker run -e CI=true nimiq/react-test npm test

after_success:
  # Dicker builds.
  - docker build -t nimiq/multi-client:latest -t nimiq/multi-client:$SHA -f ./client/Dockerfile ./client
  # Publish on Docker Hub.
  - docker push nimiq/multi-client:latest
  - docker push nimiq/multi-client:$SHA
# deploy:
#   # There is no Google Cloud Kubernetes provider in Travis CI, so we need
#   # to do it ourself in a separate script.
#   provider: script
#   script: bash ./deploy.sh
#   on:
#     branch: master
